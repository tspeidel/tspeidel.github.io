<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Thomas Speidel">
<meta name="dcterms.date" content="2023-08-31">

<title>Agreement Between Instruments – Thomas Speidel</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-d1544451c017744bb022bb3e9b517c88.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-0aef53e0ff3f583c7c9fdd21f6f55705.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>
<link href="../../site_libs/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../../site_libs/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../../site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="../../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Thomas Speidel</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../colophon.html"> 
<span class="menu-text">Colophon</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/tspeidel"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/ThomasSpeidel"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#correlation-coefficients" id="toc-correlation-coefficients" class="nav-link active" data-scroll-target="#correlation-coefficients">Correlation Coefficients</a></li>
  <li><a href="#bland-altman-plot" id="toc-bland-altman-plot" class="nav-link" data-scroll-target="#bland-altman-plot">Bland-Altman Plot</a>
  <ul class="collapse">
  <li><a href="#step-0" id="toc-step-0" class="nav-link" data-scroll-target="#step-0">Step 0</a></li>
  <li><a href="#step-1" id="toc-step-1" class="nav-link" data-scroll-target="#step-1">Step 1</a></li>
  <li><a href="#step-2" id="toc-step-2" class="nav-link" data-scroll-target="#step-2">Step 2</a></li>
  <li><a href="#step-3-interpretation" id="toc-step-3-interpretation" class="nav-link" data-scroll-target="#step-3-interpretation">Step 3: Interpretation</a></li>
  <li><a href="#notes" id="toc-notes" class="nav-link" data-scroll-target="#notes">Notes</a></li>
  </ul></li>
  <li><a href="#alternative-version" id="toc-alternative-version" class="nav-link" data-scroll-target="#alternative-version">Alternative Version</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Agreement Between Instruments</h1>
  <div class="quarto-categories">
    <div class="quarto-category">methods</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Thomas Speidel </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 31, 2023</p>
    </div>
  </div>
  
    
  </div>
  
<div>
  <div class="abstract">
    <div class="block-title">Abstract</div>
    Assessing and comparing agreement among measurement instruments.<br>
  </div>
</div>


</header>


<p><img src="Figures/screenshot-XYZ.png" class="img-fluid"></p>
<p>We sometimes need to evaluate whether a new instrument agrees with an existing one. Instrument is loosely meant as a measuring device such as a sensor or an online analyzer, but it could also be a person measuring or rating something. Therefore, we wish to quantify how much the two agree/disagree.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>To learn more, the correct terminology is intra-observer variability</p>
</div></div><p><br></p>
<section id="correlation-coefficients" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="correlation-coefficients">Correlation Coefficients</h2>
<p>There exist correlation coefficients that have been developed for these tasks. However, a critique of using correlation coefficients is that: “<em>a perfect correlation can result even when the measurements disagree by a factor of 10</em>” (Harrell, 1987).</p>
<p>The intraclass correlation coefficient (ICC) is a common one used for these tasks. Others include Cohen’s kappa statistic, Concordance Correlation Coefficient.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>See: https://hbiostat.org/bbr/obsvar</p>
</div></div><p><br></p>
</section>
<section id="bland-altman-plot" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="bland-altman-plot">Bland-Altman Plot</h2>
<p>A sensible visualization of the agreement between two measurements has been proposed by Bland and Altman. This happens to be the same as Tukey mean-difference plot. Bland and Altman develop this method to address the same shortcoming already pointed out earlier, namely, that “<em>a high correlation does not necessarily imply that there is good agreement between the two methods</em>”.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>You can read the original paper <a href="https://www.dentalage.co.uk/wp-content/uploads/2014/09/bland-altman_plot1986.pdf">here</a>. Bland and Altman wrote in the Clinical Chemistry Journal (63:10 (2017)): “<em>We certainly were not the first people to recognize that correlation coefficients did not assess agreement but rather association. Notably, we quoted Westgard and Hunt, who wrote wisely in Clinical Chemistry in 1973, “The correlation coefficient is of no practical use in the statistical analysis of comparison data”</em>.”</p>
<p><br><br></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Figures/pefr.png" class="img-fluid figure-img"></p>
<figcaption>A peak expiratory flow rate (PEFR). Credit: healthline</figcaption>
</figure>
</div>
</div></div><p>Here we illustrate the method using the authors original data on peak expiratory flow rate (PEFR) measures via two instruments: pefr1 and pefr2 on 17 subjects.</p>
<div class="cell" data-layout-align="left">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="do">## Import data used by Bland and ALtman in original paper</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>ba <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"Data/bland-altman.csv"</span>)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="co"># ba &lt;- read_csv("posts/2023-08-31-agreement-btw-instruments/Data/bland-altman.csv")</span></span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a></span>
<span id="cb1-6"><a href="#cb1-6"></a>ba <span class="sc">%&gt;%</span> </span>
<span id="cb1-7"><a href="#cb1-7"></a>  <span class="fu">kable</span>(<span class="at">escape =</span> T, <span class="at">format =</span> <span class="st">"html"</span>, <span class="at">digits =</span> <span class="dv">1</span>, <span class="at">align=</span><span class="fu">rep</span>(<span class="st">'c'</span>, <span class="dv">5</span>) ) <span class="sc">%&gt;%</span></span>
<span id="cb1-8"><a href="#cb1-8"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"responsive"</span>, <span class="st">"compact"</span>), <span class="at">full_width =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-1" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-layout-align="left">
<figure class="quarto-float quarto-float-tbl figure">
<div aria-describedby="tbl-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div class="table-responsive">
<table class="table table-striped table-hover do-not-create-environment cell table-sm small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: center;" data-quarto-table-cell-role="th">subject</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">pefr1</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">pefr2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">494</td>
<td style="text-align: center;">512</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">395</td>
<td style="text-align: center;">430</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">516</td>
<td style="text-align: center;">520</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">434</td>
<td style="text-align: center;">428</td>
</tr>
<tr class="odd">
<td style="text-align: center;">5</td>
<td style="text-align: center;">476</td>
<td style="text-align: center;">500</td>
</tr>
<tr class="even">
<td style="text-align: center;">6</td>
<td style="text-align: center;">557</td>
<td style="text-align: center;">600</td>
</tr>
<tr class="odd">
<td style="text-align: center;">7</td>
<td style="text-align: center;">413</td>
<td style="text-align: center;">364</td>
</tr>
<tr class="even">
<td style="text-align: center;">8</td>
<td style="text-align: center;">442</td>
<td style="text-align: center;">380</td>
</tr>
<tr class="odd">
<td style="text-align: center;">9</td>
<td style="text-align: center;">650</td>
<td style="text-align: center;">658</td>
</tr>
<tr class="even">
<td style="text-align: center;">10</td>
<td style="text-align: center;">433</td>
<td style="text-align: center;">445</td>
</tr>
<tr class="odd">
<td style="text-align: center;">11</td>
<td style="text-align: center;">417</td>
<td style="text-align: center;">432</td>
</tr>
<tr class="even">
<td style="text-align: center;">12</td>
<td style="text-align: center;">656</td>
<td style="text-align: center;">626</td>
</tr>
<tr class="odd">
<td style="text-align: center;">13</td>
<td style="text-align: center;">267</td>
<td style="text-align: center;">260</td>
</tr>
<tr class="even">
<td style="text-align: center;">14</td>
<td style="text-align: center;">478</td>
<td style="text-align: center;">477</td>
</tr>
<tr class="odd">
<td style="text-align: center;">15</td>
<td style="text-align: center;">178</td>
<td style="text-align: center;">259</td>
</tr>
<tr class="even">
<td style="text-align: center;">16</td>
<td style="text-align: center;">423</td>
<td style="text-align: center;">350</td>
</tr>
<tr class="odd">
<td style="text-align: center;">17</td>
<td style="text-align: center;">427</td>
<td style="text-align: center;">451</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-tbl" id="tbl-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Original data on PEFR1 and PEFR2 measruments.
</figcaption>
</figure>
</div>
</div>
<p>For completeness, we show the estimated conventional correlation coefficient (i.e.&nbsp;Pearson) and the scatterplot, knowing that this (i.e.&nbsp;correlation) is not an appropriate way to analyze these data:</p>
<div class="cell" data-layout-align="left">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">cor</span>(ba<span class="sc">$</span>pefr1, ba<span class="sc">$</span>pefr2, <span class="at">method =</span> <span class="st">"pearson"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9432794</code></pre>
</div>
</div>
<p>As the authors write in the paper: “<em>the high correlation of 0.94 for our own data conceals considerable lack of agreement between the two instruments</em>”.</p>
<p>We want to know by how much the new method is likely to differ from the old. Ideally, we want to have a sense of the value beyond which we would say the two instruments are not in agreement. This is more a business decision than a data one, and needs to consider whether the difference between the two measurements is large enough to lead to a different decision.</p>
<p><br></p>
<section id="step-0" class="level3">
<h3 class="anchored" data-anchor-id="step-0">Step 0</h3>
<p>There is a zero step in which we need to ask the subject matter expert the following question: <em>how different does the second measurement need to be from the first measurement in order for it to lead to a different decision with regard to its use?</em> Do this without peeking at the data, as it would lead to a cognitive bias (anchoring).</p>
<p><br></p>
</section>
<section id="step-1" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="step-1">Step 1</h3>
<div class="cell page-columns page-full" data-layout-align="left">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>ba <span class="sc">%&gt;%</span> </span>
<span id="cb4-2"><a href="#cb4-2"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>pefr2, <span class="at">y =</span> pefr1)) <span class="sc">+</span> </span>
<span id="cb4-3"><a href="#cb4-3"></a>  <span class="fu">geom_point</span>(<span class="at">shape=</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb4-4"><a href="#cb4-4"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">size=</span><span class="fl">0.25</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-plot1" class="quarto-float quarto-figure quarto-figure-left anchored" data-fig-align="left">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-plot1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="Figures/fig-plot1-1.png" class="img-fluid quarto-figure quarto-figure-left figure-img" width="900">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plot1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: PEFR1 vs PEFR2. The first step is to examine one measurement vs.&nbsp;the other with a 1:1 line as a reference
</figcaption>
</figure>
</div>
</div></div></div>
<p>We first plot the two methods against each other as shown in <a href="#fig-plot1" class="quarto-xref">Figure&nbsp;1</a>. This is a good start, however, the points will be clustered around the identity line thus making it difficult to assess between-method differences.</p>
<p><br></p>
</section>
<section id="step-2" class="level3">
<h3 class="anchored" data-anchor-id="step-2">Step 2</h3>
<p>We next plot the differences between the measurements (on the y-axis), against the mean of the individual differences. We then add reference lines for the grand-mean of the differences, and +/- 2 standard deviation of the grand-mean. This is shown in <a href="#tbl-2" class="quarto-xref">Table&nbsp;2</a> and <a href="#fig-plot2" class="quarto-xref">Figure&nbsp;2</a></p>
<div class="cell" data-layout-align="left">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="do">## Prepare diff, mean diff, sd of diff</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>ba <span class="ot">&lt;-</span> ba <span class="sc">%&gt;%</span> </span>
<span id="cb5-3"><a href="#cb5-3"></a>  <span class="fu">mutate</span>(<span class="at">diff =</span> pefr1<span class="sc">-</span>pefr2) <span class="sc">%&gt;%</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>  <span class="fu">mutate</span>(<span class="at">mean =</span> <span class="fu">rowMeans</span>(<span class="fu">select</span>(., <span class="fu">starts_with</span>(<span class="st">"pefr"</span>)), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb5-5"><a href="#cb5-5"></a>  <span class="fu">mutate</span>(<span class="at">diff_mean =</span> <span class="fu">mean</span>(diff)) <span class="sc">%&gt;%</span> </span>
<span id="cb5-6"><a href="#cb5-6"></a>  <span class="fu">mutate</span>(<span class="at">diff_sd =</span> <span class="fu">sd</span>(diff, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) </span>
<span id="cb5-7"><a href="#cb5-7"></a></span>
<span id="cb5-8"><a href="#cb5-8"></a>ba <span class="sc">%&gt;%</span> </span>
<span id="cb5-9"><a href="#cb5-9"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-10"><a href="#cb5-10"></a>  <span class="fu">kable</span>(<span class="at">escape =</span> T, <span class="at">format =</span> <span class="st">"html"</span>, <span class="at">digits =</span> <span class="dv">1</span>, <span class="at">align=</span><span class="fu">rep</span>(<span class="st">'c'</span>, <span class="dv">5</span>) ) <span class="sc">%&gt;%</span></span>
<span id="cb5-11"><a href="#cb5-11"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"responsive"</span>, <span class="st">"compact"</span>), <span class="at">full_width =</span> F) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-2" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-layout-align="left">
<figure class="quarto-float quarto-float-tbl figure">
<div aria-describedby="tbl-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div class="table-responsive">
<table class="table table-striped table-hover do-not-create-environment cell table-sm small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: center;" data-quarto-table-cell-role="th">subject</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">pefr1</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">pefr2</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">diff</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">mean</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">diff_mean</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">diff_sd</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">494</td>
<td style="text-align: center;">512</td>
<td style="text-align: center;">-18</td>
<td style="text-align: center;">503.0</td>
<td style="text-align: center;">-2.1</td>
<td style="text-align: center;">38.8</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">395</td>
<td style="text-align: center;">430</td>
<td style="text-align: center;">-35</td>
<td style="text-align: center;">412.5</td>
<td style="text-align: center;">-2.1</td>
<td style="text-align: center;">38.8</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">516</td>
<td style="text-align: center;">520</td>
<td style="text-align: center;">-4</td>
<td style="text-align: center;">518.0</td>
<td style="text-align: center;">-2.1</td>
<td style="text-align: center;">38.8</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-tbl" id="tbl-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Table of differences
</figcaption>
</figure>
</div>
</div>
<div class="cell" data-layout-align="left">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>ba <span class="sc">%&gt;%</span> </span>
<span id="cb6-2"><a href="#cb6-2"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> mean, <span class="at">y =</span> diff)) <span class="sc">+</span></span>
<span id="cb6-3"><a href="#cb6-3"></a>  <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">90</span>, <span class="dv">90</span>, <span class="at">by=</span><span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb6-5"><a href="#cb6-5"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> ba<span class="sc">$</span>diff_mean, <span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">linetype=</span><span class="st">"dotted"</span>) <span class="sc">+</span></span>
<span id="cb6-6"><a href="#cb6-6"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> ba<span class="sc">$</span>diff_mean <span class="sc">+</span> ba<span class="sc">$</span>diff_sd<span class="sc">*</span><span class="dv">2</span>, <span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb6-7"><a href="#cb6-7"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> ba<span class="sc">$</span>diff_mean <span class="sc">-</span> ba<span class="sc">$</span>diff_sd<span class="sc">*</span><span class="dv">2</span>, <span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb6-8"><a href="#cb6-8"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb6-9"><a href="#cb6-9"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">y =</span> ba<span class="sc">$</span>diff_mean<span class="fl">-3.5</span>, <span class="at">x =</span> <span class="dv">620</span>, <span class="at">family =</span> <span class="st">"Pragmata Pro Mono"</span>, <span class="at">size =</span> <span class="fl">3.6</span>, <span class="at">label =</span> <span class="st">"Mean of differences"</span>) <span class="sc">+</span></span>
<span id="cb6-10"><a href="#cb6-10"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">y =</span> ba<span class="sc">$</span>diff_mean <span class="sc">+</span> ba<span class="sc">$</span>diff_sd<span class="sc">*</span><span class="dv">2</span> <span class="sc">+</span> <span class="dv">4</span>, <span class="at">x =</span> <span class="dv">620</span>, <span class="at">face =</span> <span class="st">"italic"</span>, <span class="at">size =</span> <span class="fl">3.6</span>, <span class="at">family =</span> <span class="st">"Pragmata Pro Mono"</span>, <span class="at">label =</span> <span class="st">"Mean + 2 SD"</span>) <span class="sc">+</span></span>
<span id="cb6-11"><a href="#cb6-11"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">y =</span> ba<span class="sc">$</span>diff_mean <span class="sc">-</span> ba<span class="sc">$</span>diff_sd<span class="sc">*</span><span class="dv">2</span> <span class="sc">-</span> <span class="dv">4</span>, <span class="at">x =</span> <span class="dv">620</span>, <span class="at">face =</span> <span class="st">"italic"</span>, <span class="at">size =</span> <span class="fl">3.6</span>, <span class="at">family =</span> <span class="st">"Pragmata Pro Mono"</span>, <span class="at">label =</span> <span class="st">"Mean - 2 SD"</span>) <span class="sc">+</span></span>
<span id="cb6-12"><a href="#cb6-12"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">Mean PEFR of two instruments (l/min)"</span>,</span>
<span id="cb6-13"><a href="#cb6-13"></a>       <span class="at">y =</span> <span class="st">"Difference in PEFR (PEFR1-PEFR2)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-plot2" class="quarto-float quarto-figure quarto-figure-left anchored" data-fig-align="left">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-plot2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="Figures/fig-plot2-1.png" class="img-fluid quarto-figure quarto-figure-left figure-img" width="2100">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plot2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Bland-Altman plot of the difference between the measurements against the mean and sd.
</figcaption>
</figure>
</div>
</div>
</div>
<p><br></p>
</section>
<section id="step-3-interpretation" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="step-3-interpretation">Step 3: Interpretation</h3>
<p>Let’s interpret <a href="#fig-plot2" class="quarto-xref">Figure&nbsp;2</a>. There is considerable lack of agreement between PEFR1 and PEFR2 with discrepancies of up to 80 l/min. We see no obvious patterns in the plot. Because there is no pattern, we can summarize the lack of agreement by calculating the bias as the mean of the differences: -2.1 and a sd of 38.8.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>An example of a pattern could be that the agreement gets better or worse at higher values of the x-axis. In this case, it would not make see to calculate the bias because that depends on the value of the mean. <br><br><br></p>
</div></div><div class="cell page-columns page-full" data-layout-align="left">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>ba <span class="sc">%&gt;%</span> </span>
<span id="cb7-2"><a href="#cb7-2"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> diff)) <span class="sc">+</span></span>
<span id="cb7-3"><a href="#cb7-3"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> ..density..), <span class="at">binwidth =</span> <span class="dv">2</span><span class="sc">*</span><span class="fu">IQR</span>(ba<span class="sc">$</span>diff)<span class="sc">/</span><span class="fu">length</span>(ba<span class="sc">$</span>diff)<span class="sc">^</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>), <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb7-4"><a href="#cb7-4"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span></span>
<span id="cb7-5"><a href="#cb7-5"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">""</span>,</span>
<span id="cb7-6"><a href="#cb7-6"></a>       <span class="at">x =</span> <span class="st">"Difference (PEFR1-PEFR2)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div id="fig-plot3" class="quarto-float quarto-figure quarto-figure-left anchored" data-fig-align="left">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-plot3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="Figures/fig-plot3-1.png" class="img-fluid quarto-figure quarto-figure-left figure-img" width="1200">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plot3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Histogram of differences.
</figcaption>
</figure>
</div>
</div></div></div>
<p>If the differences follow a normal distribution (something that would be expected), then we can infer that 95% of the differences would lie between +/- 2 standard deviations of the mean (1.96 to be precise). In any event, one can plot a histogram to get a sense of the distribution, as shown in <a href="#fig-plot3" class="quarto-xref">Figure&nbsp;3</a>.</p>
<p>We then calculate the <strong>limits of agreement</strong> as shown in the graph as follows:</p>
<p><span class="math display">\[bias-2sd=-2.1-(2*38.8)=-80\]</span> <span class="math display">\[bias+2sd=-2.1+(2*38.8)=76\]</span></p>
<p>Now, refer back to step 0: if differences as large as +/-2sd are deemed of no practical importance by the subject matter experts, then, the two measurement methods could be used interchangeably. However, if differences as large as +/- 2sd are unacceptable, then the two measurement do not agree and the new meter (PEFR2), having differences of 80 l/min below, or 76 l/min above the old meter (PEFR1), is not acceptable.</p>
<p><br></p>
</section>
<section id="notes" class="level3">
<h3 class="anchored" data-anchor-id="notes">Notes</h3>
<ul>
<li>If we see that the scatter in <a href="#fig-plot2" class="quarto-xref">Figure&nbsp;2</a> increases as the mean PEFR increases, we can try a log-transform, apply the analysis, and then back-transform the findings to the original scale.</li>
</ul>
</section>
</section>
<section id="alternative-version" class="level1">
<h1>Alternative Version</h1>
<p>Many analytics projects in oil &amp; gas and engineering applications involve quantifying how well two instruments agree with each other. Usually, this is motivated by one instrument being more cost effective than the other. An example would be the development of a soft-sensor used to replace a hardware sensor, an expensive lab test or to be used as a virtual sensor in digital twin applications.</p>
<p>A typical analysis involves calculating a measure of correlation, like the Pearson correlation coefficient, and concluding the two instruments “agree” if the correlation is arbitrarily high, say &gt;90%.</p>
<p>When developing soft sensors, it’s not unusual to observe high correlation or high predictive accuracy between the soft and the hardware sensors. However, we need to keep a healthy dose of skepticism when facing promising metrics because a high correlation may “conceal considerable lack of agreement between two instruments” (ref here). This is bad news for something that, on the surface, may appear as trivially simple.</p>
<p>A high correlation doesn’t mean your prediction is sufficient to justify replacing one instrument with another. You may not have the necessary level of agreement between the prediction and the true measurement. Consider, for example, the trivial case in which the new measurement is using a different scale: in this case you may have high correlation but poor agreement. Measures of correlations and predictive accuracy such as Pearson correlation or its distant relative R^2 quantify the strength of a relationship. However, agreement is not the same as correlation.</p>
<p>Ideally, we first need to ask ourselves how much the new instrument (the soft-sensor in our example) need to change from the old (the hardware sensor in our example) for us to conclude that the two are different. Sometimes, the answer is provided to us by, say, a regulatory body, but other times we need to figure it out.</p>
<p>If you are training predictive models, as in the case of soft-sensor development, keep an eye on multiple measures of agreement and discrimination, not just the usual accuracy metrics like R^2 and RMSE. Some of those measures are concordance metrics such as Kendall’s coefficient of concordance (W) or the intraclass correlation coefficient (ICC). Another effective method that is not only easy to compute but also information rich is the Bland-Altman plot (despite its name, it was originally proposed by Tukey as the Tukey mean-difference plot). The Bland-Altman plot will tell us, among other things, whether the new instrument complies with our initial requirement. The Bland-Altman plot should be done even if you are on the receiving end of these models.</p>
<div class="cell" data-layout-align="left">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="fu">library</span>(gganimate)</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="fu">library</span>(rms)</span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="fu">library</span>(ggtext)</span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="fu">library</span>(ggthemes)</span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="fu">library</span>(extrafont)</span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="fu">library</span>(irr)</span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="fu">library</span>(DescTools)</span>
<span id="cb8-9"><a href="#cb8-9"></a><span class="fu">library</span>(av)</span>
<span id="cb8-10"><a href="#cb8-10"></a><span class="fu">font_import</span>()</span>
<span id="cb8-11"><a href="#cb8-11"></a><span class="fu">loadfonts</span>()</span>
<span id="cb8-12"><a href="#cb8-12"></a><span class="fu">theme_set</span>(<span class="fu">theme_fivethirtyeight</span>(<span class="at">base_family =</span> <span class="st">'Roboto Condensed'</span>))</span>
<span id="cb8-13"><a href="#cb8-13"></a></span>
<span id="cb8-14"><a href="#cb8-14"></a><span class="do">## Simualte data</span></span>
<span id="cb8-15"><a href="#cb8-15"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb8-16"><a href="#cb8-16"></a>x1 <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">200</span>)<span class="sc">*</span><span class="dv">10</span></span>
<span id="cb8-17"><a href="#cb8-17"></a>y <span class="ot">&lt;-</span> x1 <span class="sc">+</span> <span class="dv">5</span> <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">200</span>)<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb8-18"><a href="#cb8-18"></a>y2 <span class="ot">&lt;-</span> x1 <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">200</span>)<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb8-19"><a href="#cb8-19"></a></span>
<span id="cb8-20"><a href="#cb8-20"></a></span>
<span id="cb8-21"><a href="#cb8-21"></a><span class="do">## Place into several df (for later)</span></span>
<span id="cb8-22"><a href="#cb8-22"></a>df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(y) <span class="sc">%&gt;%</span></span>
<span id="cb8-23"><a href="#cb8-23"></a>  <span class="fu">mutate</span>(<span class="at">y2 =</span> y2) <span class="sc">%&gt;%</span> </span>
<span id="cb8-24"><a href="#cb8-24"></a>  <span class="fu">mutate</span>(<span class="at">x1 =</span> x1)</span>
<span id="cb8-25"><a href="#cb8-25"></a></span>
<span id="cb8-26"><a href="#cb8-26"></a>tmp1 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">select</span>(y, x1) </span>
<span id="cb8-27"><a href="#cb8-27"></a>tmp2 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="at">y =</span> y2, x1)</span>
<span id="cb8-28"><a href="#cb8-28"></a></span>
<span id="cb8-29"><a href="#cb8-29"></a></span>
<span id="cb8-30"><a href="#cb8-30"></a><span class="do">## Calculate corr measures:</span></span>
<span id="cb8-31"><a href="#cb8-31"></a>r1 <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">cor</span>(y, x1, <span class="at">method =</span> <span class="st">"pearson"</span>), <span class="dv">2</span>)</span>
<span id="cb8-32"><a href="#cb8-32"></a>r2 <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">cor</span>(y2, x1, <span class="at">method =</span> <span class="st">"pearson"</span>), <span class="dv">2</span>)</span>
<span id="cb8-33"><a href="#cb8-33"></a></span>
<span id="cb8-34"><a href="#cb8-34"></a>icc1 <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">as.numeric</span>(<span class="fu">icc</span>(tmp1, <span class="at">model =</span> <span class="st">"twoway"</span>, <span class="at">type =</span> <span class="st">"agreement"</span>, <span class="at">unit =</span> <span class="st">"single"</span>)[<span class="dv">7</span>]), <span class="dv">2</span>)</span>
<span id="cb8-35"><a href="#cb8-35"></a>icc2 <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">as.numeric</span>(<span class="fu">icc</span>(tmp2, <span class="at">model =</span> <span class="st">"twoway"</span>, <span class="at">type =</span> <span class="st">"agreement"</span>, <span class="at">unit =</span> <span class="st">"single"</span>)[<span class="dv">7</span>]), <span class="dv">2</span>)</span>
<span id="cb8-36"><a href="#cb8-36"></a></span>
<span id="cb8-37"><a href="#cb8-37"></a>w1 <span class="ot">&lt;-</span> <span class="fu">KendallW</span>(tmp1, <span class="cn">TRUE</span>, <span class="at">test=</span><span class="cn">FALSE</span>, <span class="at">correct =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-38"><a href="#cb8-38"></a>w2 <span class="ot">&lt;-</span> <span class="fu">KendallW</span>(tmp2, <span class="cn">TRUE</span>, <span class="at">test=</span><span class="cn">FALSE</span>, <span class="at">correct =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-39"><a href="#cb8-39"></a></span>
<span id="cb8-40"><a href="#cb8-40"></a><span class="do">## Other df</span></span>
<span id="cb8-41"><a href="#cb8-41"></a>df2 <span class="ot">&lt;-</span> tmp1 <span class="sc">%&gt;%</span> </span>
<span id="cb8-42"><a href="#cb8-42"></a>  <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"Y1"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-43"><a href="#cb8-43"></a>  <span class="fu">bind_rows</span>(tmp2 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"Y2"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb8-44"><a href="#cb8-44"></a>  <span class="do">## Add annotation layer</span></span>
<span id="cb8-45"><a href="#cb8-45"></a>  <span class="fu">mutate</span>(<span class="at">annotation =</span> <span class="fu">case_when</span>(type <span class="sc">==</span> <span class="st">"Y1"</span> <span class="sc">~</span> <span class="fu">paste</span>(<span class="st">"Pearson (correlation):"</span>, r1, <span class="st">"</span><span class="sc">\n</span><span class="st">ICC (agreement):"</span>, icc1),</span>
<span id="cb8-46"><a href="#cb8-46"></a>                                type <span class="sc">==</span> <span class="st">"Y2"</span> <span class="sc">~</span> <span class="fu">paste</span>(<span class="st">"Pearson (correlation):"</span>, r2, <span class="st">"</span><span class="sc">\n</span><span class="st">ICC (agreement):"</span>, icc2))) <span class="sc">%&gt;%</span> </span>
<span id="cb8-47"><a href="#cb8-47"></a>  <span class="fu">mutate</span>(<span class="at">annotation =</span> <span class="fu">replace</span>(annotation, <span class="fu">duplicated</span>(annotation), <span class="cn">NA</span>))</span>
<span id="cb8-48"><a href="#cb8-48"></a></span>
<span id="cb8-49"><a href="#cb8-49"></a></span>
<span id="cb8-50"><a href="#cb8-50"></a><span class="do">## Plot and animate</span></span>
<span id="cb8-51"><a href="#cb8-51"></a><span class="co"># options(ragg.max_dim = 1000)</span></span>
<span id="cb8-52"><a href="#cb8-52"></a></span>
<span id="cb8-53"><a href="#cb8-53"></a>anim <span class="ot">&lt;-</span>df2 <span class="sc">%&gt;%</span> </span>
<span id="cb8-54"><a href="#cb8-54"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> y, <span class="at">x =</span> x1)) <span class="sc">+</span> </span>
<span id="cb8-55"><a href="#cb8-55"></a>  <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="dv">21</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">size =</span> <span class="dv">5</span>, <span class="at">fill =</span> <span class="st">"red"</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb8-56"><a href="#cb8-56"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linewidth =</span> <span class="fl">0.3</span>, <span class="at">color =</span> <span class="st">"grey30"</span>) <span class="sc">+</span></span>
<span id="cb8-57"><a href="#cb8-57"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> annotation, <span class="at">y =</span> <span class="fl">2.2</span>, <span class="at">x =</span> <span class="fl">5.6</span>),</span>
<span id="cb8-58"><a href="#cb8-58"></a>            <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">family =</span> <span class="st">"Space Mono"</span>, <span class="at">size =</span> <span class="fl">7.2</span>) <span class="sc">+</span></span>
<span id="cb8-59"><a href="#cb8-59"></a>  <span class="fu">coord_fixed</span>(<span class="at">ratio=</span><span class="dv">1</span>, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb8-60"><a href="#cb8-60"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">15</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">15</span>, <span class="at">by =</span> <span class="dv">5</span>)) <span class="sc">+</span></span>
<span id="cb8-61"><a href="#cb8-61"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">15</span>)) <span class="sc">+</span></span>
<span id="cb8-62"><a href="#cb8-62"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"&lt;br&gt;Old instrument&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;br&gt;&lt;br&gt;&lt;br&gt;"</span>,</span>
<span id="cb8-63"><a href="#cb8-63"></a>       <span class="at">y =</span> <span class="st">"&lt;br&gt;New instrument&lt;br&gt;"</span>,</span>
<span id="cb8-64"><a href="#cb8-64"></a>       <span class="at">title =</span> <span class="st">"&lt;br&gt;Correlation vs. Agreement&lt;br&gt;"</span>) <span class="sc">+</span></span>
<span id="cb8-65"><a href="#cb8-65"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_markdown</span>(<span class="at">size =</span> <span class="dv">44</span>),</span>
<span id="cb8-66"><a href="#cb8-66"></a>        <span class="at">axis.title =</span> <span class="fu">element_markdown</span>(<span class="at">size =</span> <span class="dv">26</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb8-67"><a href="#cb8-67"></a>        <span class="at">axis.text =</span> <span class="fu">element_markdown</span>(<span class="at">size =</span> <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb8-68"><a href="#cb8-68"></a>  <span class="fu">transition_states</span>(type,</span>
<span id="cb8-69"><a href="#cb8-69"></a>                    <span class="at">transition_length =</span> <span class="dv">2</span>,</span>
<span id="cb8-70"><a href="#cb8-70"></a>                    <span class="at">state_length =</span> <span class="dv">1</span>)</span>
<span id="cb8-71"><a href="#cb8-71"></a></span>
<span id="cb8-72"><a href="#cb8-72"></a><span class="fu">animate</span>(anim, <span class="at">renderer =</span> <span class="fu">av_renderer</span>(), <span class="at">height =</span> <span class="dv">600</span>, <span class="at">width =</span> <span class="dv">600</span>, <span class="at">res =</span> <span class="dv">60</span>)</span>
<span id="cb8-73"><a href="#cb8-73"></a><span class="fu">anim_save</span>(<span class="st">"posts/2023-08-31-agreement-btw-instruments/Data/1_animation.webm"</span>)</span>
<span id="cb8-74"><a href="#cb8-74"></a></span>
<span id="cb8-75"><a href="#cb8-75"></a></span>
<span id="cb8-76"><a href="#cb8-76"></a></span>
<span id="cb8-77"><a href="#cb8-77"></a><span class="do">## BA plot</span></span>
<span id="cb8-78"><a href="#cb8-78"></a>blandaltman <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb8-79"><a href="#cb8-79"></a>  <span class="fu">mutate</span>(<span class="at">diff =</span> y2 <span class="sc">-</span> x1) <span class="sc">%&gt;%</span></span>
<span id="cb8-80"><a href="#cb8-80"></a>  <span class="fu">mutate</span>(<span class="at">mean =</span> <span class="fu">rowMeans</span>(<span class="fu">select</span>(., <span class="fu">starts_with</span>(<span class="st">"y"</span>)), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb8-81"><a href="#cb8-81"></a>  <span class="fu">mutate</span>(<span class="at">diff_mean =</span> <span class="fu">mean</span>(diff)) <span class="sc">%&gt;%</span></span>
<span id="cb8-82"><a href="#cb8-82"></a>  <span class="fu">mutate</span>(<span class="at">diff_sd =</span> <span class="fu">sd</span>(diff, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb8-83"><a href="#cb8-83"></a></span>
<span id="cb8-84"><a href="#cb8-84"></a>anim2 <span class="ot">&lt;-</span> blandaltman <span class="sc">%&gt;%</span></span>
<span id="cb8-85"><a href="#cb8-85"></a>  <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"A"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-86"><a href="#cb8-86"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> mean, <span class="at">y =</span> diff)) <span class="sc">+</span></span>
<span id="cb8-87"><a href="#cb8-87"></a>  <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="dv">21</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">size =</span> <span class="dv">5</span>, <span class="at">fill =</span> <span class="st">"red"</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb8-88"><a href="#cb8-88"></a>  <span class="fu">scale_y_continuous</span>() <span class="sc">+</span></span>
<span id="cb8-89"><a href="#cb8-89"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> blandaltman<span class="sc">$</span>diff_mean, <span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">linetype=</span><span class="st">"dotted"</span>) <span class="sc">+</span></span>
<span id="cb8-90"><a href="#cb8-90"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> blandaltman<span class="sc">$</span>diff_mean <span class="sc">+</span> blandaltman<span class="sc">$</span>diff_sd<span class="sc">*</span><span class="dv">2</span>, <span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb8-91"><a href="#cb8-91"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> blandaltman<span class="sc">$</span>diff_mean <span class="sc">-</span> blandaltman<span class="sc">$</span>diff_sd<span class="sc">*</span><span class="dv">2</span>, <span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb8-92"><a href="#cb8-92"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"&lt;br&gt;Mean of two instruments&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;br&gt;&lt;br&gt;&lt;br&gt;"</span>,</span>
<span id="cb8-93"><a href="#cb8-93"></a>       <span class="at">y =</span> <span class="st">"&lt;br&gt;Instrument 1 - Instrument 2&lt;br&gt;"</span>,</span>
<span id="cb8-94"><a href="#cb8-94"></a>       <span class="at">title =</span> <span class="st">"&lt;br&gt;Bland-Altman Plot&lt;br&gt;"</span>) <span class="sc">+</span></span>
<span id="cb8-95"><a href="#cb8-95"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_markdown</span>(<span class="at">size =</span> <span class="dv">26</span>),</span>
<span id="cb8-96"><a href="#cb8-96"></a>        <span class="at">axis.title =</span> <span class="fu">element_markdown</span>(<span class="at">size =</span> <span class="dv">16</span>, <span class="at">hjust =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb8-97"><a href="#cb8-97"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">y =</span> blandaltman<span class="sc">$</span>diff_mean<span class="fl">-0.08</span>, <span class="at">x =</span> <span class="fl">13.2</span>, <span class="at">family =</span> <span class="st">"Space Mono"</span>, <span class="at">size =</span> <span class="dv">7</span>, <span class="at">label =</span> <span class="st">"Mean of differences"</span>, <span class="at">check_overlap =</span> <span class="cn">TRUE</span>, <span class="at">hjust=</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb8-98"><a href="#cb8-98"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">y =</span> blandaltman<span class="sc">$</span>diff_mean <span class="sc">+</span> blandaltman<span class="sc">$</span>diff_sd<span class="sc">*</span><span class="dv">2</span> <span class="sc">+</span> <span class="fl">0.08</span>, <span class="at">x =</span> <span class="fl">13.2</span>, <span class="at">size =</span> <span class="dv">7</span>, <span class="at">family =</span> <span class="st">"Space Mono"</span>, <span class="at">label =</span> <span class="st">"Mean + 2 SD"</span>, <span class="at">check_overlap =</span> <span class="cn">TRUE</span>, <span class="at">hjust=</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb8-99"><a href="#cb8-99"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">y =</span> blandaltman<span class="sc">$</span>diff_mean <span class="sc">-</span> blandaltman<span class="sc">$</span>diff_sd<span class="sc">*</span><span class="dv">2</span> <span class="sc">-</span> <span class="fl">0.08</span>, <span class="at">x =</span> <span class="fl">13.2</span>, <span class="at">size =</span> <span class="dv">7</span>, <span class="at">family =</span> <span class="st">"Space Mono"</span>, <span class="at">label =</span> <span class="st">"Mean - 2 SD"</span>, <span class="at">check_overlap =</span> <span class="cn">TRUE</span>, <span class="at">hjust=</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb8-100"><a href="#cb8-100"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_markdown</span>(<span class="at">size =</span> <span class="dv">44</span>),</span>
<span id="cb8-101"><a href="#cb8-101"></a>        <span class="at">axis.title =</span> <span class="fu">element_markdown</span>(<span class="at">size =</span> <span class="dv">26</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb8-102"><a href="#cb8-102"></a>        <span class="at">axis.text =</span> <span class="fu">element_markdown</span>(<span class="at">size =</span> <span class="dv">20</span>))</span>
<span id="cb8-103"><a href="#cb8-103"></a>  <span class="co"># transition_states(type,</span></span>
<span id="cb8-104"><a href="#cb8-104"></a>  <span class="co">#                   transition_length = 0.1,</span></span>
<span id="cb8-105"><a href="#cb8-105"></a>  <span class="co">#                   state_length = 0.1)</span></span>
<span id="cb8-106"><a href="#cb8-106"></a>anim2</span>
<span id="cb8-107"><a href="#cb8-107"></a><span class="co"># animate(anim2, renderer = av_renderer(), height = 600, width = 600, res = 60)</span></span>
<span id="cb8-108"><a href="#cb8-108"></a><span class="co"># anim_save("posts/2023-08-31-agreement-btw-instruments/Data/2_animation.webm")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><video src="Data/1_animation.webm" class="img-fluid" controls=""><a href="Data/1_animation.webm">Video</a></video></p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>